<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>
			{% block title %}Welcome!
			{% endblock %}
		</title>
		<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text></svg>">
		{# Run `composer require symfony/webpack-encore-bundle` to start using Symfony UX #}
		<!-- Font Awesome -->
		<link
		rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/> <!-- Google Fonts Roboto -->
		<link
		rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
		<!-- MDB ESSENTIAL -->
		<link rel="stylesheet" href="/css/mdb.min.css"/>
		<!-- MDB PLUGINS -->
		{# <link
								rel="stylesheet" href="/css/mdb-plugins.min.css"/> #}
		<link
		rel="stylesheet" href="/plugins/css/all.min.css"/> <!-- Custom styles -->
		<link rel="stylesheet" href="/css/style.css"/>
	</head>
	<body>
		{% include "components/navbar.html.twig" %}
		<div class="container"> {% block body %}{% endblock %}
			</div>

			<!-- MDB ESSENTIAL -->
			<script type="text/javascript" src="/js/mdb.min.js"></script>
			<!-- MDB PLUGINS -->
			<script type="text/javascript" src="/plugins/js/all.min.js"></script>

	{% if is_granted('ROLE_USER') %}
		<script>
			var sender;
			const eventSource = new EventSource("{{ mercure('https://localhost/users/' ~ app.user.id ~ '/messages')|escape('js') }}");
			console.log(eventSource);
			eventSource.onmessage = event => { // Will be called every time an update is published by the server
				console.log(JSON.parse(event.data));
				data = JSON.parse(event.data);
				sender = data.sent.id;

				const element = document.getElementById("message-box");
				console.log(element);

				const uri = {{ app.user.id }};
				console.log(uri);
				const date = (new Date(data.createdAt)).toUTCString();
				console.log(date);

				const template = document.createElement('template');
				template.innerHTML = `<div class="d-flex flex-row justify-content-${sender === uri ? "end" : "start"}">
                    <img src="${data.sent.avatar}"
                      alt="avatar 1" style="width: 45px; height: 100%;">
                    <div>
                      <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: ${sender === uri ?"#f5f6f7":"rgba(129,198,190,1)"};">${data.content}</p>
                      <p class="small ms-3 mb-3 rounded-3 text-muted float-${sender === uri ? "end" : "start"}">${date}</p>
                    </div>
                  </div>`
				element.appendChild(template.content);
				}

		{% if activity is defined %}

			function sendMessage() {
				var inputField = document.getElementById("message-input");
				var message = inputField.value;
				console.log({{ activity.owner.id }});
				console.log({{ app.user.id }});
				console.log(sender);
				{% if activity.owner.id is same as (app.user.id) %}messageTarget = sender;
				{% else %}
				messageTarget = {{ activity.owner.id }};
				{% endif %}
				const messageData = {
					content: message,
					recipient: '/users/' + messageTarget,
					sent: '/users/' + {{ app.user.id }}
				}

				fetch('https://localhost/messages', {
				method: 'POST',
				headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
				},
				body: JSON.stringify(messageData)
				});

			}
		document.getElementById("button-addon2").addEventListener("click", sendMessage);

		{% endif %}
		document.addEventListener('DOMContentLoaded', function() {
		// Récupérer les messages depuis la base de données
		fetch('https://localhost/messages')
			.then(response => response.json())
			.then(data => {
				// Parcourir les messages et les afficher
				data.forEach(message => {
					const element = document.getElementById("message-box");

					const template = document.createElement('template');
					template.innerHTML = `<div class="d-flex flex-row justify-content-${message.sent === uri ? "end" : "start"}">
						<img src="${message.sent.avatar}" alt="avatar 1" style="width: 45px; height: 100%;">
						<div>
							<p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: ${message.sent === uri ?"#f5f6f7":"rgba(129,198,190,1)"};">${message.content}</p>
							<p class="small ms-3 mb-3 rounded-3 text-muted float-${message.sent === uri ? "end" : "start"}">${message.date}</p>
						</div>
					</div>`;

					element.appendChild(template.content);
				});
       		 })
			 
        .catch(error => {
            console.error('Une erreur s\'est produite lors de la récupération des messages :', error);
        });
});

	</script>

	{% endif %}

	</body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>
			{% block title %}Welcome!
			{% endblock %}
		</title>
		<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text></svg>">
		{# Run `composer require symfony/webpack-encore-bundle` to start using Symfony UX #}
		<!-- Font Awesome -->
		<link
		rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/> <!-- Google Fonts Roboto -->
		<link
		rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
		<!-- MDB ESSENTIAL -->
		<link rel="stylesheet" href="/css/mdb.min.css"/>
		<!-- MDB PLUGINS -->
		{# <link
								rel="stylesheet" href="/css/mdb-plugins.min.css"/> #}
		<link
		rel="stylesheet" href="/plugins/css/all.min.css"/> <!-- Custom styles -->
		<link rel="stylesheet" href="/css/style.css"/>
	</head>
	<body>
		{% include "components/navbar.html.twig" %}
		<div class="container"> {% block body %}{% endblock %}
			</div>

			<!-- MDB ESSENTIAL -->
			<script type="text/javascript" src="/js/mdb.min.js"></script>
			<!-- MDB PLUGINS -->
			<script type="text/javascript" src="/plugins/js/all.min.js"></script>

	{% if is_granted('ROLE_USER') %}
		<script>
			var sender;
			const eventSource = new EventSource("{{ mercure('https://localhost/users/' ~ app.user.id ~ '/messages')|escape('js') }}");
			console.log(eventSource);
			eventSource.onmessage = event => { // Will be called every time an update is published by the server
				console.log(JSON.parse(event.data));
				data = JSON.parse(event.data);
				sender = data.sent.id;

				const element = document.getElementById("message-box");
				console.log(element);

				const uri = {{ app.user.id }};
				console.log(uri);
				const date = (new Date(data.createdAt)).toUTCString();
				console.log(date);

				const template = document.createElement('template');
				template.innerHTML = `<li class="d-flex justify-content-between mb-4">
						<img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/avatar-6.webp" alt="avatar" class="rounded-circle d-flex align-self-${sender === uri ? "end" : "start"} me-3 shadow-1-strong" width="60">
						<div class="card mask-custom">
							<div class="card-header d-flex justify-content-between p-3" style="border-bottom: 1px solid rgba(255,255,255,.3);">
								<p class="fw-bold mb-0">${data.sent.username}</p>
								<p class="text-light small mb-0">
									<i class="far fa-clock"></i>
									${date}</p>
							</div>
							<div class="card-body">
								<p class="mb-0">
									${data.content}
								</p>
							</div>
						</div>
					</li>`;
				element.appendChild(template.content);
				}

		{% if activity is defined %}

			function sendMessage() {
				var inputField = document.getElementById("message-input");
				var message = inputField.value;
				console.log({{ activity.owner.id }});
				console.log({{ app.user.id }});
				console.log(sender);
				{% if activity.owner.id is same as (app.user.id) %}messageTarget = sender;
				{% else %}
				messageTarget = {{ activity.owner.id }};
				{% endif %}
				const messageData = {
					content: message,
					recipient: '/users/' + messageTarget,
					sent: '/users/' + {{ app.user.id }}
				}

				fetch('https://localhost/messages', {
				method: 'POST',
				headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
				},
				body: JSON.stringify(messageData)
				});

			}
		document.getElementById("button-addon2").addEventListener("click", sendMessage);
		
		{% endif %}
	</script>

	{% endif %}

	</body>
</html>
